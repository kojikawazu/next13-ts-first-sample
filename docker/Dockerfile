# ベースとなるイメージを指定
FROM node:16.17.1

# ---------------------------------------------------
# ユーザ設定
# ---------------------------------------------------
RUN adduser --disabled-password --gecos '' appuser

# ---------------------------------------------------
# 作業ディレクトリの設定
# ---------------------------------------------------
WORKDIR /app
RUN chown -R appuser:appuser /app

# ---------------------------------------------------
# 依存関係のファイルをコピー
# ---------------------------------------------------
COPY package*.json ./
RUN chown appuser:appuser /app/package*.json

# ---------------------------------------------------
# 依存関係のインストール
# ---------------------------------------------------
RUN npm install

# ---------------------------------------------------
# アプリケーションのソースをコピー
# ---------------------------------------------------
COPY . .

# ---------------------------------------------------
# ファイル配置
# ---------------------------------------------------
RUN chown -R appuser:appuser /app
RUN mv -f /app/scripts/entrypoint/entryPoint.sh /app/.

# ---------------------------------------------------
# 所有者変更
# ---------------------------------------------------
RUN chmod +x *.sh
RUN printf "$(ls -altr /app)\n"

# ---------------------------------------------------
# ビルド
# ---------------------------------------------------
USER appuser
RUN npm run build
RUN printf "$(ls -altr /app)\n"

# ---------------------------------------------------
# 3000番ポートを公開
# ---------------------------------------------------
EXPOSE 3000

# ---------------------------------------------------
# コンテナ起動時に実行するコマンド
# ---------------------------------------------------
ENTRYPOINT ["/app/entryPoint.sh"]
